<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../slash-handler/slash-handler.html">

<dom-module id="item-ajax">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <iron-ajax
      id="ajax"
      auto="false"
      handle-as="json"
      on-response="_handleResponse"
      on-error="_handleError"
      debounce-duration="300"></iron-ajax>
    <h2 id="title"></h2>
    <hr>
    <div id="main"></div>
    <hr>
    <div id="foot"></div>
    <hr>
    <paper-textarea id="tarea" label="JSON from REST API, furnished to corroborate above:"
                    value="No JSON YET"></paper-textarea>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'item-ajax',

        behaviors: [SlashHandler.PassUrl],

        properties: {
          deslashedurl: {
            type: String,
            notify: true,
            observer: 'entryPoint'
          },
          jsonObject: {
            type: Object,
            notify: true
          },
          viewType: {
            type: String,
            notify: true
          },
          bodyDiv: {
            type: Function,
            value: function () {
              return this.$.main;
            }
          },
          titleDiv: {
            type: Function,
            value: function () {
              return this.$.title;
            }
          },
          footerDiv: {
            type: Function,
            value: function () {
              return this.$.foot;
            }
          }
        },
        _handleResponse: function (data) {
          this.jsonObj = null;
          this.viewType = null;
          if (this.deslashedurl) {
            if (data.detail.response) {
              this.jsonObj = data.detail.response;
              this.viewType = this._computeViewType;
              var jsonTextArea = this.$.tarea;
              jsonTextArea.value = JSON.stringify(this.jsonObj, null, '\t');
              this.fire('response');
            }
          }
        }
        ,
        _handleError: function (data) {
//          DfHateoas.HandleError._handleError(data);
        },
        entryPoint: function () {
          this.$.ajax.url = SlashHandler.PassUrl.decodeUrl(this.deslashedurl);

        },
        _computeViewType: function () {
          this.viewType = "other";
          var keys = this._keys(this.jsonObject);
          var hasLinks = this._contains("_links", keys);
          var hasSearch = this._hasLinksSearch();
          var hasEmbedded = this._contains("_embedded", keys);
          var hasPage = this._contains("page", keys);
          var hasNext = this._hasLinksNext();
          var hasPrev = this._hasLinksPrev();
          var hasLinksProfile = this._hasLinksProfile();
          if (hasLinks && hasLinksProfile && keys.length == 1) {
            this.viewType = "rootView"
          }
          if (hasLinks && hasSearch && hasEmbedded && hasPage && hasNext && hasPrev) {
            return "middleItems";
          }
          if (hasLinks && hasSearch && hasEmbedded && hasPage && hasNext) {
            this.viewType = "beginItems";
          }
          if (hasLinks && hasSearch && hasEmbedded && hasPage && hasPrev) {
            this.viewType = "endItems";
          }
          if (hasLinks && !hasSearch && !hasEmbedded && !hasPage && !hasLinksProfile && keys.length > 1) {
            this.viewType = "itemView";
          }
          if (hasLinks && keys.length == 1) {
            this.viewType = "searchView";
          }
        }
        ,

        _keys: function (obj) {
          var keys = [];
          if (obj === undefined || obj == null) {
            return null;
          }
          for (var key in obj) {
            var attrName = key;
            keys.push(key);
          }
          return keys;
        }
        ,

        _hasLinksProfile: function () {
          if (this.jsonObject === undefined || this.jsonObject == null) {
            return false;
          }
          if (this.jsonObject._links != null
            && this.jsonObject._links.profile != undefined
            && this.jsonObject._links.profile.href != undefined) {
            return true;
          }
          return false;
        }
        ,

        _hasLinksSelf: function () {
          if (this.jsonObject === undefined || this.jsonObject == null) {
            return false;
          }
          if (this.jsonObject._links != null
            && this.jsonObject._links.self != undefined
            && this.jsonObject._links.self.href != undefined) {
            return true;
          }
          return false;
        }
        ,

        _hasLinksNext: function () {
          if (this.jsonObject === undefined || this.jsonObject == null) {
            return false;
          }
          if (this.jsonObject._links != null
            && this.jsonObject._links.next != undefined
            && this.jsonObject._links.next.href != undefined) {
            return true;
          }
          return false;
        }
        ,

        _hasLinksPrev: function () {
          if (this.jsonObject === undefined || this.jsonObject == null) {
            return false;
          }
          if (this.jsonObject._links != null
            && this.jsonObject._links.prev != undefined
            && this.jsonObject._links.prev.href != undefined) {
            return true;
          }
          return false;
        }
        ,

        _hasLinksSearch: function () {
          if (this.jsonObject === undefined || this.jsonObject == null) {
            return false;
          }
          if (this.jsonObject._links != null
            && this.jsonObject._links.search != undefined
            && this.jsonObject._links.search.href != undefined) {
            return true;
          }
          return false;
        }
        ,

        _contains: function (obj, arr) {
          if (obj === undefined || obj === null || arr === undefined || arr == null) {
            return false;
          }
          var i = arr.length;
          while (i--) {
            if (arr[i] === obj) {
              return true;
            }
          }
          return false;
        }

      });
    })();
  </script>
</dom-module>
