<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../item-update-bar/item-update-bar.html">

<dom-module id="item-view">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <item-update-bar on-update="updateRecord" on-delete="deleteRecord" on-create="createRecord"></item-update-bar>
    <item-ajax
      id="itemajax"
      deslashedurl="{{viewurl}}"
      on-response="populate">
    </item-ajax>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'item-view',

        properties: {
          viewurl: {
            type: String,
            notify: true
          },
          titleName: {
            type: String,
            notify: true
          }
        },
        populateTitle: function () {
          this.$.itemajax.titleDiv.innerText = this.extractTitle(this.$.itemajax.deslashedurl);
        },

        extractTitle: function (url) {
          var target = "" + url;
          target = target.split('_');
          var id = target.pop();
          var name = target.pop();
          return name + " (id=" + id + ")";
        },

        createFieldInputBox: function (key, value) {
          if (key.startsWith("_")) {
            return;
          }
          var bodyDiv = this.$.itemajax.bodyDiv;
          var descripText = document.createElement("H3");
          var fieldInputBox = document.createElement("paper-textarea");
          var brElement = document.createElement("BR");
          descripText.innerText = key;
          fieldInputBox.value = value;
          bodyDiv.appendChild(descripText);
          bodyDiv.appendChild(fieldInputBox);
          bodyDiv.appendChild(brElement);
        },

        createCheckBox: function (key, value) {
          if (key.startsWith("_")) {
            return;
          }
          var bodyDiv = this.$.itemajax.bodyDiv;
          var descripText = document.createElement("H3");
          var checkBox = document.createElement("paper-checkbox");
          if (value) {
            checkBox.setAttribute('checked', true);
          }
          var brElement = document.createElement("BR");
          descripText.innerText = key;
//          fieldInputBox.value = value;
          bodyDiv.appendChild(descripText);
          bodyDiv.appendChild(checkBox);
          bodyDiv.appendChild(brElement);
        },

        populateBody: function () {
          this.$.itemajax.bodyDiv.innerHTML = "";
          var obj = false;
          try {
            obj = this.$.itemajax.jsonObj;
          } catch (err) {
            console.log("APPEARS TO BE A PROBLEM WITH " + this.viewUrl);
          }
          if (obj) {
            for (var key in obj) {
              var attrName = key;
              if (obj[key] === true || obj[key] === false) {
                this.createCheckBox(key, obj[key]);
              } else {
                this.createFieldInputBox(key, obj[key]);
              }
            }
          }
        },
        populateFooter: function () {
          // no op because couldn't figure out how to make on-create
          // or on-update work from an element created with javascript
          // so created above, in html argh
        },

        populate: function () {
          this.populateTitle();
          this.populateBody();
          this.populateFooter();
        },
        updateRecord: function () {
          console.log("SOME KIND OF UPDATE");
          var elem = document.getElementById('inputform').elements;
          var hasFields = false;
          var fieldAttributeObject = {};
          for (var i = 0; i < elem.length; i++) {
            if (elem[i].value && elem[i].getAttribute("name")) {
              hasFields = true;
              fieldAttributeObject[elem[i].getAttribute("name")] = elem[i].value;
              console.log(":"+fieldAttributeObject[elem[i].getAttribute("name")]+ "="+elem[i].value)
            }
          }
//          if (hasFields) {
//            var body = JSON.stringify(fieldAttributeObject);
//            this.$.itemajax.manual;
//            this.$.itemajax.ajaxBody = body;
//            this.$.itemajax.deslashedurl = this.tableurl;
//            this.$.itemajax.ajaxMethod = "POST";
//            this.$.itemajax.generateAjaxRequest();
//            this.$.itemajax.auto;
//          }
        },
        deleteRecord: function () {
          var obj = false;
          try {
            obj = this.$.itemajax.jsonObj;
            this.$.itemajax.manual;
            this.$.itemajax.ajaxMethod = "DELETE";
            this.$.itemajax.generateAjaxRequest();
            this.$.itemajax.auto;
            window.history.back();
          } catch (err) {
            console.log("APPEARS TO BE A PROBLEM WITH " + JSON.stringify(this.err));
          }
        }
      });
    })();
  </script>
</dom-module>
