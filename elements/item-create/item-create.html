<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<dom-module id="item-create">
  <template>
    <style>
      :host {
        display: block;
      }

    </style>
    <form id="inputform">
      <input type="button" on-click="createnewrecord" value="Submit form">
    </form>
    <item-ajax
      id="itemajax"
      on-response="wellheck">
    </item-ajax>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'item-create',

        properties: {
          createurl: {
            type: String,
            notify: true,
            observer: 'wellheck'
          },
          schemaspec: {
            type: String,
            notify: true,
            observer: 'initializeForm'
          },
          schemaObject: {
            type: Object,
            notify: true
          },
          titleName: {
            type: String,
            notify: true
          }
        },
        initializeForm: function () {
          this.schemaObject = JSON.parse(this.schemaspec);
          this.populateTitle();
          var fieldForm = this.$.inputform;
          fieldForm.setAttribute("id", "inputform");
          this.populateBody(fieldForm);
          this.$.itemajax.bodyDiv.appendChild(fieldForm);
        },
        populateTitle: function () {
          this.$.itemajax.titleDiv.innerText = this.extractTitle(this.createurl);
        },
        wellheck: function () {
          if (this.$.itemajax.jsonObject) {
            alert("you got a response, see code\n" + this.$.itemajax.response.detail);
          }
        },

        extractTitle: function (url) {
          var target = "" + url;
          target = target.split('_');
          var name = target.pop();
          return "Create new " + name + ":";
        },
        createFormField: function (key, value, form, type) {
          if (key.startsWith("_")) {
            return;
          } else {
            var inputField = document.createElement(type);
            inputField.label = key;
            inputField.setAttribute('idname', key);
            inputField.setAttribute("name", key);
            inputField.value = value;
            if (type == "paper-checkbox" && value) {
              inputField.setAttribute('truefalse', true);
            }
            form.appendChild(inputField);
            form.appendChild(document.createElement("BR"));
          }
        },
        populateBody: function (form) {
          if (this.schemaObject) {
            var schema = this.schemaObject;
            for (var key in schema) {
              var myValueType = schema[key];
              if (myValueType && myValueType["valueType"]) {
                var fieldType = myValueType["valueType"];
                if (fieldType == "integer" || fieldType == "decimal" || fieldType == "shortText" || fieldType == "integer") {
                  this.createFormField(key, "", form, "paper-input");
                } else if (fieldType == "longText") {
                  this.createFormField(key, "", form, "polyrest-textarea");
                } else if (fieldType == "boolean") {
                  this.createFormField(key, true, form, "polyrest-checkbox");
                }
              }
            }
          }
        },
        populateFooter: function () {
        },
        populate: function () {
          this.populateTitle();
          this.populateBody();
          this.populateFooter();
        },
        createnewrecord: function (e) {
          var elem = document.getElementById('inputform').elements;
          var hasFields = false;
          var fieldAttributeObject = {};
          for (var i = 0; i < elem.length; i++) {
            if (elem[i].value && elem[i].getAttribute("name")) {
              hasFields = true;
              fieldAttributeObject[elem[i].getAttribute("name")] = elem[i].value;
            }
          }
          if (hasFields) {
            var body = JSON.stringify(fieldAttributeObject);
            this.$.itemajax.manual;
            this.$.itemajax.ajaxBody = body;
            this.$.itemajax.deslashedurl = this.createurl;
            this.$.itemajax.ajaxMethod = "POST";
            this.$.itemajax.generateAjaxRequest();
            this.$.itemajax.auto;
          }
        }
      });
    })();
  </script>
</dom-module>
