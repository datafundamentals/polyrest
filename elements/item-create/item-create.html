<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<dom-module id="item-create">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-icon-button {
        margin-left: 5px;
        margin-right: 5px;
        display: block;
        text-align: center;
        color: #ff3e52;
        width: 50px;
      }
    </style>
    <item-ajax
      id="itemajax"
      on-response="populate">
    </item-ajax>
    <span>Click icon when ready to create this record:</span>
    <paper-icon-button id="createrecord" icon="create"></paper-icon-button>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'item-create',
        listeners: {
          'createrecord.tap': 'createnewrecord'
        },


        properties: {
          createurl: {
            type: String,
            notify: true
          },
          schemaspec: {
            type: String,
            notify: true,
            observer: 'initializeForm'
          },
          schemaObject: {
            type: Object,
            notify: true
          },
          titleName: {
            type: String,
            notify: true
          }
        },
        initializeForm: function () {
          this.schemaObject = JSON.parse(this.schemaspec);
          this.populateTitle();
          var fieldForm = document.createElement("form");
          fieldForm.setAttribute("id", "inputform");
          this.populateBody(fieldForm);
          this.$.itemajax.bodyDiv.appendChild(fieldForm);
        },
        populateTitle: function () {
          this.$.itemajax.titleDiv.innerText = this.extractTitle("http:__172.99.79.10:8156_task");
        },

        extractTitle: function (url) {
          var target = "" + url;
          target = target.split('_');
          var name = target.pop();
          return "Create new " + name + ":";
        },

        createFormField: function (key, value, form, type) {
          if (key.startsWith("_")) {
            return;
          } else {
            var inputField = document.createElement(type);
            inputField.setAttribute("name", key);
            inputField.value = value;
            inputField.label = key;
            form.appendChild(inputField);
            var isCheckbox = (type == "paper-checkbox") ? true : false;
            if (isCheckbox) {
              var descripText = document.createElement("span");
              if (value) {
                inputField.setAttribute('checked', true);
              }
              descripText.innerText = key;
              form.appendChild(descripText);
            }
            form.appendChild(document.createElement("BR"));
          }
        },

        populateBody: function (form) {
          if (this.schemaObject) {
            var schema = this.schemaObject;
            for (var key in schema) {
              var myValueType = schema[key];
              if (myValueType && myValueType["valueType"]) {
                var fieldType = myValueType["valueType"];
                if (fieldType == "integer" || fieldType == "decimal" || fieldType == "shortText" || fieldType == "integer") {
                  this.createFormField(key, "", form, "paper-input");
                } else if (fieldType == "longText") {
                  this.createFormField(key, "", form, "paper-textarea");
                } else if (fieldType == "boolean") {
                  this.createFormField(key, true, form, "paper-checkbox");
                }
              }
            }
//            for (var key in obj) {
//              var attrName = key;
//              if (obj[key] === true || obj[key] === false) {
//                this.createCheckBox(key, obj[key]);
//              } else {
//                this.createFieldTextArea(key, obj[key]);
//              }
//            }
          }
        },
        populateFooter: function () {
          // no op because couldn't figure out how to make on-create
          // or on-update work from an element created with javascript
          // so created above, in html argh
        },

        populate: function () {
          this.populateTitle();
          this.populateBody();
          this.populateFooter();
        },
        createnewrecord: function (e) {
          console.log("SOME KIND OF FUNCTIONALITY");
          var elem = document.getElementById('inputform').elements;
          var objectToCreate = {};
          for (var i = 0; i < elem.length; i++) {
            console.log("hi " + elem[i].value + "\t" + elem[i].getAttribute("name"));
          }
        }
      });
    })();
  </script>
</dom-module>
