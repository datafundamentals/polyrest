<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<dom-module id="item-select">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <item-create-bar on-create="createRecord"></item-create-bar>
    <item-ajax
      id="itemajax"
      deslashedurl="{{selecturl}}"
      on-response="populate">
    </item-ajax>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'item-select',
        properties: {
          titleName: {
            type: String,
            notify: true
          }
        },


        populateTitle: function () {
          var obj = this.$.itemajax.jsonObj._embedded;
          if (obj) {
            for (var key in obj) {
              this.$.itemajax.titleDiv.innerText = key;
              this.titleName = key;
              break;
            }
          } else {
            this.$.itemajax.titleDiv.innerText = "No Data Found For This Link"
          }
        },
        populateTable: function () {
          var recordCount = false
          try {
            recordCount = this.$.itemajax.jsonObj.page.size;
          } catch (err) {
            recordCount = 1000;
          }
          var firstRecord = false;
          try {
            firstRecord = this.$.itemajax.jsonObj._embedded[(this.titleName)][0];
          } catch (err) {
          }
          this.tableHeads = [];
          if (firstRecord) {
            for (var key in firstRecord) {
              this.tableHeads.push(key);
            }
          }
          if (this.tableHeads.length > 0) {
            var tableDiv = this.$.itemajax.bodyDiv;
            tableDiv.innerText = "";
            var table = document.createElement('TABLE');
            table.border = 1;
            var tableHead = document.createElement('THEAD');
            table.appendChild(tableHead);
            for (var i = 0; i < 3; i++) {
              var td = document.createElement('TH');
              td.width = '75';
              td.appendChild(document.createTextNode(this.tableHeads[i]));
              tableHead.appendChild(td);
            }
            var linktd = document.createElement('TH');
            linktd.width = '50';
            linktd.appendChild(document.createTextNode("links"));
            tableHead.appendChild(linktd);
            var tableBody = document.createElement('TBODY');
            table.appendChild(tableBody);
            for (var i = 0; i < recordCount; i++) {
              var record = this.$.itemajax.jsonObj._embedded[(this.titleName)][i];
              if (record) {
                var tr = document.createElement('TR');
                tableBody.appendChild(tr);
                var values = [];
                for (var key in record) {
                  var attrName = key;
                  values.push(record[key]);
                }
                for (var j = 0; j < 3; j++) {
                  var td = document.createElement('TD');
                  td.width = '75';
                  var value = values[j];
                  if (value.length > 12) {
                    value = value.substring(0, 12);
                  }
                  td.appendChild(document.createTextNode(value));
                  tr.appendChild(td);
                }
                this.addItemViewLink(tr, record);
              }
            }
            tableDiv.appendChild(table);
          }
        },
        populateFooter: function () {
          var footerDiv = this.$.itemajax.footerDiv;
          footerDiv.innerText = "";
          var nextLinkVal = false;
          try {
            nextLinkVal = this.$.itemajax.jsonObj._links.next.href;
          } catch (err) {
          }
          var prevLinkVal = false;
          try {
            prevLinkVal = this.$.itemajax.jsonObj._links.prev.href;
          } catch (err) {
          }
          if (prevLinkVal) {
            var space = document.createElement('SPAN');
            space.innerText = '  ';
            var link = document.createElement('A');
            link.setAttribute("href", prevLinkVal);
            link.innerText = "prev";
            footerDiv.appendChild(link);
            footerDiv.appendChild(space);
          }
          if (nextLinkVal) {
            var space = document.createElement('SPAN');
            space.innerText = '  ';
            var link = document.createElement('A');
            link.setAttribute("href", nextLinkVal);
            link.innerText = "next";
            footerDiv.appendChild(link);
            footerDiv.appendChild(space);
          }
          var searchLinkVal = false;
          try {
            searchLinkVal = this.$.itemajax.jsonObj._links.search.href;
          } catch (err) {
          }
          if (searchLinkVal) {
            var space = document.createElement('SPAN');
            space.innerText = '  ';
            var link = document.createElement('A');
            link.setAttribute("href", searchLinkVal);
            link.innerText = "search";
            footerDiv.appendChild(link);
            footerDiv.appendChild(space);
          }
        }

        ,
        addItemViewLink: function (tr, record) {
          var link = "";
          try {
            link = record._links.self.href;
            link = this.$.itemajax.specialEncodeUrl("/itemview/", link);
          } catch (err) {
            if (record) {
              console.log("UNABLE TO PROCESS LINK:\n" + JSON.stringify(record)+ "\nERR\n"+ err);
            }
          }
          var td = document.createElement('TD');
          td.width = '50';
          var aref = document.createElement('A');
          aref.setAttribute("href", link);
          aref.innerText = "view";
          td.appendChild(aref);
          tr.appendChild(td);
        }
        ,
        populate: function () {
          this.populateTitle();
          this.populateTable();
          this.populateFooter();
        }
        ,
        createRecord: function () {
          console.log("SOME KIND OF CREATE");
        }

      })
      ;
    })
    ();
  </script>
</dom-module>
