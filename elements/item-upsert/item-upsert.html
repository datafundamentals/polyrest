<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<dom-module id="item-upsert">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-icon-button {
                margin-left: 5px;
                margin-right: 5px;
                display: block;
                text-align: center;
                color: #60ff67;
                width: 50px;
                height: 50px;
                background: rgb(66, 184, 221);
                border-radius: 4px;
            }

        </style>
        <h2 id="title">hi</h2>
        <hr>
        <form id="inputform">
            <span id="createReadyLabel">Create </span>
            <paper-icon-button id=submitCreateButton label="click" icon="add"
                               on-click="createnewrecord">Create
            </paper-icon-button>
            <span id="updateReadyLabel">Update </span>
            <paper-icon-button id=submitUpdateButton label="click" icon="redo"
                               on-click="updateRecord"></paper-icon-button>
            <span id="deleteReadyLabel">Delete </span>
            <paper-icon-button id=submitDeleteButton label="click" icon="delete"
                               on-click="deleteRecord"></paper-icon-button>
        </form>
        <iron-ajax
                id="ajax"
                auto="false"
                handle-as="json"
                content-type="application/json"
                on-response="_handleResponse"
                on-error="_handleError"
                debounce-duration="300"></iron-ajax>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'item-upsert',

                behaviors: [SlashHandler.PassUrl],

                properties: {
                    createurl: {
                        type: String,
                        notify: true
                    },
                    schemaspec: {
                        type: String,
                        notify: true
                    },
                    schemaObject: {
                        type: Object,
                        notify: true
                    },
                    recordid: {
                        type: String,
                        notify: true
                    },
                    titleName: {
                        type: String,
                        notify: true
                    },
                    itemObject: {
                        type: Object,
                        notify: true
                    },
                    itemJson: {
                        type: String,
                        notify: true
                    },
                    isUpdate: {
                        type: Boolean,
                        notify: true,
                        value: false
                    }
                },
                observers: [
                    'fetchContent(createurl, recordid)', 'initializeForm(schemaspec, itemObject)'
                ],
                toggleUpdate: function () {
                    if (this.recordid && this.recordid > -1) {
//                        console.log("UPDATE TOGGLED to OFF " + this.recordid);
                        this.isUpdate = true;
                        this.$.createReadyLabel.setAttribute("hidden", true);
                        this.$.submitCreateButton.setAttribute("hidden", true);
                        this.$.updateReadyLabel.removeAttribute("hidden");
                        this.$.submitUpdateButton.removeAttribute("hidden");
                        this.$.deleteReadyLabel.removeAttribute("hidden");
                        this.$.submitDeleteButton.removeAttribute("hidden");
                    } else {
//                        console.log("UPDATE TOGGLED to ON " + this.recordid);
                        this.$.createReadyLabel.removeAttribute("hidden");
                        this.$.submitCreateButton.removeAttribute("hidden");
                        this.$.updateReadyLabel.setAttribute("hidden", true);
                        this.$.submitUpdateButton.setAttribute("hidden", true);
                        this.$.deleteReadyLabel.setAttribute("hidden", true);
                        this.$.submitDeleteButton.setAttribute("hidden", true);
                    }
                },
                fetchContent: function () {
                    this.populateTitle();
                    this.toggleUpdate();
                    if (this.isUpdate) {
                        var realUrl = SlashHandler.PassUrl.decodeUrl(this.createurl) + "/" + this.recordid;
                        console.log("FETCH FOR " + realUrl);
                        this.$.ajax.auto = false;
                        this.$.ajax.method = "GET";
                        this.$.ajax.url = realUrl;
                        this.$.ajax.generateRequest();
                    }else{
                        this.initializeForm();
                    }
                },
                initializeForm: function () {
                    console.log("SCHEMA:\n" + this.schemaspec);
                    this.schemaObject = JSON.parse(this.schemaspec);
                    this.populateTitle();
                    var fieldForm = this.$.inputform;
                    this.populateBody(fieldForm);
                },
                populateTitle: function () {
//          console.log(this.createurl);
                    this.$.title.innerText = this.extractTitle(this.createurl);
                },
                _handleResponse: function (data) {
                    if (data && data.detail.response) {
                        this.itemObject = data.detail.response;
                        this.itemJson = JSON.stringify(this.itemObject);
                        console.log("RESPONSE RECEIVED:\n" + this.itemJson);
                    }
                },
                _handleError: function () {
                    if (!this.$.ajax.url) {
                        alert("error");
                    }
                },
                extractTitle: function (url) {
                    var target = "" + url;
                    target = target.split('_');
                    var name = target.pop();
                    return "Create new " + name + ":";
                },
                createFormField: function (key, value, form, type) {
                    if (key.startsWith("_")) {
                        return;
                    } else {
                        var inputField = document.createElement(type);
                        inputField.label = key;
                        inputField.setAttribute('idname', key);
                        inputField.setAttribute("name", key);
                        inputField.value = value;
                        if (type == "paper-checkbox" && value) {
                            inputField.setAttribute('truefalse', true);
                        }
                        form.appendChild(inputField);
                        form.appendChild(document.createElement("BR"));
                    }
                },
                populateBody: function (form) {
//          console.log("RECORDID: " + this.recordid);
                    if (this.schemaObject) {
                        var schema = this.schemaObject;
                        for (var key in schema) {
                            var myValueType = schema[key];
                            if (myValueType && myValueType["valueType"]) {
                                var fieldType = myValueType["valueType"];
                                if (fieldType == "integer" || fieldType == "decimal" || fieldType == "shortText" || fieldType == "integer") {
                                    this.createFormField(key, "", form, "paper-input");
                                } else if (fieldType == "longText") {
                                    this.createFormField(key, "", form, "polyrest-textarea");
                                } else if (fieldType == "boolean") {
                                    this.createFormField(key, true, form, "polyrest-checkbox");
                                }
                            }
                        }
                    }
                },
                populate: function () {
                    this.populateTitle();
                    this.populateBody();
                },
                createnewrecord: function (e) {
                    var elem = document.getElementById('inputform').elements;
                    var hasFields = false;
                    var fieldAttributeObject = {};
                    for (var i = 0; i < elem.length; i++) {
                        if (elem[i].value && elem[i].getAttribute("name")) {
                            hasFields = true;
                            fieldAttributeObject[elem[i].getAttribute("name")] = elem[i].value;
                            console.log(":" + fieldAttributeObject[elem[i].getAttribute("name")] + "=" + elem[i].value)
                        }
                    }
                    if (hasFields) {
                        var realUrl = SlashHandler.PassUrl.decodeUrl(this.createurl);
//                        console.log("SUBMIT:\n" + JSON.stringify(fieldAttributeObject) + "\n" + realUrl);
                        this.$.ajax.auto = false;
                        this.$.ajax.body = JSON.stringify(fieldAttributeObject);
                        this.$.ajax.method = "POST";
                        this.$.ajax.url = realUrl;
                        this.$.ajax.generateRequest();
                        window.history.back();
                    }
                },
                deleteRecord: function () {
                    var obj = false;
                    try {
                        obj = this.$.itemajax.jsonObj;
                        this.$.itemajax.manual;
                        this.$.itemajax.ajaxMethod = "DELETE";
                        this.$.itemajax.generateAjaxRequest();
                        this.$.itemajax.auto;
                        window.history.back();
                    } catch (err) {
                        console.log("APPEARS TO BE A PROBLEM WITH " + JSON.stringify(this.err));
                    }
                },
                updateRecord: function () {
                    console.log("SOME KIND OF UPDATE");
                    var elem = document.getElementById('inputform').elements;
                    var hasFields = false;
                    var fieldAttributeObject = {};
                    for (var i = 0; i < elem.length; i++) {
                        if (elem[i].value && elem[i].getAttribute("name")) {
                            hasFields = true;
                            fieldAttributeObject[elem[i].getAttribute("name")] = elem[i].value;
                            console.log(":" + fieldAttributeObject[elem[i].getAttribute("name")] + "=" + elem[i].value)
                        }
                    }
//          if (hasFields) {
//            var body = JSON.stringify(fieldAttributeObject);
//            this.$.itemajax.manual;
//            this.$.itemajax.ajaxBody = body;
//            this.$.itemajax.deslashedurl = this.createurl;
//            this.$.itemajax.ajaxMethod = "POST";
//            this.$.itemajax.generateAjaxRequest();
//            this.$.itemajax.auto;
//          }
                }
            });
        })();
    </script>
</dom-module>
